{% extends "tutoring/base_sia.html" %}
{% load static %}

{% block title %}Detalle del reporte de acci贸n tutorial{% endblock %}
{% block nav_tutoring_active %}active{% endblock %}

{% block content %}
<h4 class="section-title">Detalle del reporte de acci贸n tutorial</h4>

<div class="row">
  <!-- Columna izquierda: datos del reporte -->
  <div class="col-lg-7 mb-4">
    <div class="card dashboard-card">
      <div class="card-body">
        <h5 class="mb-1">{{ report.title }}</h5>
        <p class="text-muted mb-2">
          <strong>Periodo:</strong> {{ report.period }}<br>
          <strong>Tutor:</strong> {{ report.tutor.get_full_name|default:report.tutor.username }}<br>
          <strong>Fecha de env铆o:</strong> {{ report.created_at|date:"d/m/Y H:i" }}
        </p>

        <hr>

        <h6 class="fw-semibold">Contenido del reporte</h6>
        <p style="white-space:pre-line;">{{ report.content }}</p>

        <hr>

        <h6 class="fw-semibold mb-2">Archivo Excel</h6>
        {% if report.attachment %}
          <a href="{{ report.attachment.url }}" target="_blank"
            class="btn btn-outline-success btn-sm">
            <i class="bi bi-file-earmark-spreadsheet"></i> Abrir archivo Excel
          </a>
        {% else %}
          <p class="text-muted mb-0">No se adjunt贸 archivo Excel.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Columna derecha: estado + retroalimentaci贸n -->
  <div class="col-lg-5 mb-4">
    <div class="card dashboard-card">
      <div class="card-body">
        <h5 class="mb-3">
          <i class="bi bi-pencil-square me-1"></i> Retroalimentaci贸n y estado
        </h5>

        <!--  NUEVO FORMULARIO AQUI -->
        <form method="post" class="mt-2">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label fw-semibold">Retroalimentaci贸n para el tutor</label>
            <textarea name="feedback" rows="5" class="form-control"
                      placeholder="Escribe aqu铆 tus observaciones, comentarios y recomendaciones para el tutor...">{{ report.feedback }}</textarea>
          </div>

          <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
            <a href="{% url 'coordinator_report_inbox' %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left"></i> Volver a bandeja
            </a>

            <div class="btn-group">
              <button type="submit" name="action" value="review" class="btn btn-success">
                <i class="bi bi-check2-circle me-1"></i> Marcar como revisado
              </button>
              <button type="submit" name="action" value="return" class="btn btn-warning">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Devolver al tutor
              </button>
              <button type="submit" name="action" value="send_head" class="btn btn-primary">
                <i class="bi bi-send-fill me-1"></i> Enviar al Jefe de Depto
              </button>
            </div>
          </div>

          {% if report.status == "RETURNED" %}
            <div class="alert alert-warning mt-3 mb-0">
              Este reporte se ha marcado como <strong>devuelto</strong>.
              El tutor podr谩 actualizarlo y volver a enviarlo con un nuevo archivo.
            </div>
          {% elif report.status == "SENT_TO_HEAD" %}
            <div class="alert alert-info mt-3 mb-0">
              Este reporte fue <strong>enviado al Jefe de Departamento</strong>
              {% if report.sent_to_head_at %}
                el {{ report.sent_to_head_at|date:"d/m/Y H:i" }}.
              {% endif %}
            </div>
          {% endif %}
        </form>
        <!--  FIN NUEVO FORMULARIO -->

      </div>
    </div>
  </div>

</div>
{% endblock %}
