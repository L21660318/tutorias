{# apps/tutoring/templates/tutoring/dashboard.html #}
{% extends "base.html" %}

{% block title %}SIA Tutorías - Panel del Tutor{% endblock %}
{% block nav_tutoring_active %}active{% endblock %}

{% block content %}

  <!-- Acciones Rápidas -->
  <div class="row mb-4">
    <div class="col-12">
      <h4 class="section-title">Acciones Rápidas</h4>
    </div>

    <!-- Nueva Sesión -->
    <div class="col-md-3 col-6 mb-3">
      <a href="#"
         class="quick-action-btn action-1"
         data-bs-toggle="modal"
         data-bs-target="#actionModal"
         data-url="{% url 'tutoring_session_new' %}"
         data-title="Nueva sesión de tutoría">
        <i class="bi bi-calendar-plus"></i>
        <div>Nueva Sesión</div>
      </a>
    </div>

    <!-- Ver Alertas -->
    <div class="col-md-3 col-6 mb-3">
      <a href="#"
         class="quick-action-btn action-2"
         data-bs-toggle="modal"
         data-bs-target="#actionModal"
         data-url="/alerts/"
         data-title="Alertas del tutorado">
        <i class="bi bi-exclamation-triangle"></i>
        <div>Ver Alertas <span class="badge bg-danger">{{ alerts_count }}</span></div>
      </a>
    </div>

    <!-- Generar Reporte -->
    <div class="col-md-3 col-6 mb-3">
      <a href="#"
         class="quick-action-btn action-3"
         data-bs-toggle="modal"
         data-bs-target="#actionModal"
         data-url="{% url 'tutor_report_create' %}"
         data-title="Generar reporte de acción tutorial">
        <i class="bi bi-file-earmark-text"></i>
        <div>Generar Reporte</div>
      </a>
    </div>

        <!-- Mis reportes -->
    <div class="col-md-3 col-6 mb-3">
      <a href="#"
         class="quick-action-btn action-1"
         data-bs-toggle="modal"
         data-bs-target="#actionModal"
         data-url="{% url 'tutor_report_list' %}"
         data-title="Mis reportes de acción tutorial">
        <i class="bi bi-folder2-open"></i>
        <div>Mis reportes</div>
      </a>
    </div>


    <!-- Asignar a Psicólogo -->
    <div class="col-md-3 col-6 mb-3">
      <a href="#"
         class="quick-action-btn action-4"
         data-bs-toggle="modal"
         data-bs-target="#actionModal"
         data-url="{% url 'psychology_assign_student' %}"
         data-title="Asignar alumno a psicólogo">
        <i class="bi bi-heart-pulse"></i>
        <div>Asignar a Psicólogo</div>
      </a>
    </div>

    <!-- Entrevistas con alumnos -->
    <div class="col-md-3 col-6 mb-3">
      <a href="#"
         class="quick-action-btn action-3"
         data-bs-toggle="modal"
         data-bs-target="#actionModal"
         data-url="{% url 'interview_list' %}"
         data-title="Entrevistas con alumnos">
        <i class="bi bi-person-lines-fill"></i>
        <div>Entrevistas con alumnos</div>
      </a>
    </div>
    <a href="{% url 'tutor_certificates' %}" class="btn btn-sm btn-primary">
        <i class="bi bi-award me-1"></i> Ver mis constancias
    </a>

  </div>

  <!-- Stats Dashboard -->
  <div class="row">
    <div class="col-md-3 col-6 mb-4">
      <div class="dashboard-card card stat-1">
        <div class="card-body text-center">
          <div class="card-icon">
            <i class="bi bi-people-fill"></i>
          </div>
          <h3 class="stats-number">{{ stats.students_count }}</h3>
          <p class="stats-label">Estudiantes tutorados</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-4">
      <div class="dashboard-card card stat-2">
        <div class="card-body text-center">
          <div class="card-icon">
            <i class="bi bi-person-check"></i>
          </div>
          <h3 class="stats-number">{{ stats.tutors_count }}</h3>
          <p class="stats-label">Tutores activos</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-4">
      <div class="dashboard-card card stat-3">
        <div class="card-body text-center">
          <div class="card-icon">
            <i class="bi bi-calendar-event"></i>
          </div>
          <h3 class="stats-number">{{ stats.sessions_this_month }}</h3>
          <p class="stats-label">Sesiones este mes</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-4">
      <div class="dashboard-card card stat-4">
        <div class="card-body text-center">
          <div class="card-icon">
            <i class="bi bi-clipboard-check"></i>
          </div>
          <h3 class="stats-number">{{ stats.program_progress }}%</h3>
          <p class="stats-label">Avance del programa</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Resumen de actividades recientes -->
  <div class="row">
    <div class="col-12">
      <div class="dashboard-card card">
        <div class="card-body">
          <h4 class="section-title">Resumen de Actividades Recientes</h4>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Estudiante / Grupo</th>
                  <th>Tutor</th>
                  <th>Tipo</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for s in recent_sessions %}
                  <tr>
                    <td>{{ s.scheduled_date|date:"d/m/Y H:i" }}</td>
                    <td>
                      {% if s.tutee %}
                        {{ s.tutee.get_full_name|default:s.tutee.username }}
                      {% elif s.group %}
                        {{ s.group.name }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>{{ s.tutor.get_full_name|default:s.tutor.username }}</td>
                    <td>{{ s.get_kind_display }}</td>
                    <td>
                      {% if s.status == "COMPLETED" %}
                        <span class="badge bg-success">Completada</span>
                      {% elif s.status == "SCHEDULED" %}
                        <span class="badge bg-warning text-dark">Programada</span>
                      {% elif s.status == "CANCELED" %}
                        <span class="badge bg-danger">Cancelada</span>
                      {% elif s.status == "NO_SHOW" %}
                        <span class="badge bg-secondary">Inasistencia</span>
                      {% else %}
                        <span class="badge bg-light text-dark">{{ s.status }}</span>
                      {% endif %}
                    </td>
                    <td>
                      <a href="/sessions/{{ s.id }}/" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-clipboard-check me-1"></i> Pasar lista
                      </a>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="6" class="text-center text-muted">
                      No hay sesiones registradas recientemente.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="text-center mt-3">
            <a href="/tutoring/sessions/" class="btn btn-primary">Ver Todas las Sesiones</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <h5 class="card-title">Mis constancias por grupo</h5>
  <table class="table table-striped">
      <thead>
          <tr>
              <th>Grupo</th>
              <th>Periodo</th>
              <th>Emitida por</th>
              <th>Fecha</th>
              <th>Archivo</th>
          </tr>
      </thead>
      <tbody>
          {% for c in my_group_certificates %}
          <tr>
              <td>{{ c.group.name }}</td>
              <td>{{ c.period }}</td>
              <td>{{ c.coordinator.get_full_name }}</td>
              <td>{{ c.uploaded_at|date:"d/m/Y" }}</td>
              <td>
                  <a href="{{ c.pdf.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-file-earmark-pdf"></i> Descargar
                  </a>
              </td>
          </tr>
          {% empty %}
          <tr>
              <td colspan="5" class="text-center">Aún no tienes constancias.</td>
          </tr>
          {% endfor %}
      </tbody>
  </table>


  <!-- Modal genérico para Acciones Rápidas -->
  <div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="actionModalLabel">Acción</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body p-0">
          <iframe id="actionModalFrame"
                  src="about:blank"
                  frameborder="0"
                  style="width: 100%; min-height: 75vh;"></iframe>
        </div>
      </div>
    </div>
  </div>



{% endblock %}

{% block extra_scripts %}
<script>
  const actionModal = document.getElementById('actionModal');

  if (actionModal) {
    actionModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      if (!button) return;

      const url = button.getAttribute('data-url');
      const title = button.getAttribute('data-title') || 'Acción';
      const frame = document.getElementById('actionModalFrame');
      const titleEl = document.getElementById('actionModalLabel');

      if (titleEl) {
        titleEl.textContent = title;
      }

      if (frame && url) {
        frame.src = url;
      }
    });

    actionModal.addEventListener('hidden.bs.modal', function () {
      const frame = document.getElementById('actionModalFrame');
      if (frame) {
        frame.src = 'about:blank';
      }
    });
  }
</script>
{% endblock %}
